// Find iframes that used the One Trust data-src format that are not converted.
// Replace them with a text message about needing consent granted.
window.addEventListener('load', (event) => {
    let iframes = document.querySelectorAll('iframe[class*="optanon-category-"]');
    for (let iframe of iframes) {
        if(!iframe.src) {
            // Create and insert Consent Message.
            let consentMessage = document.querySelector('.consent-message');
            if (!consentMessage) {
                consentMessage = document.createElement('div');
                consentMessage.classList.add('consent-message');
                iframe.parentNode.insertBefore(consentMessage, iframe);
            }
            consentMessage.innerHTML =
                'Please view'
                + ' <button class="ot-sdk-show-settings">Cookies Settings</button>'
                + ' to load content.';
            iframe.addEventListener('load', function() {
                consentMessage.remove();
            });
        }
    }
});

// Automatically withdraw consent for tracking for anyone on the do-not-share
// list. Only check if we set the data subject id in the global scope, which
// implies that you are logged in.
if (
    typeof OneTrust === 'object'
    && typeof OneTrust.dataSubjectParams === 'object'
    && typeof OneTrust.dataSubjectParams.id !== 'undefined'
    && typeof OneTrust.wpnonce !== 'undefined'
    && typeof sessionStorage.doNotShare === 'undefined'
) {
    // Fetch Do Not Share status. Pass nonce as set by plugin.
    fetch('/wp-json/clorox-security/v1/is-do-not-share/?_wpnonce=' + OneTrust.wpnonce)
        .then(response => response.json())
        .then((response) => {
            if (response.status === 0) {
                // Save state to session storage so that we don't check again.
                sessionStorage.doNotShare = response.data.doNotShare;
                if (response.data.doNotShare) {
                    // Update consent.
                    OneTrust.UpdateConsent('Category','C0004:0');
                }
            } else {
                // Check failed, so we assume we are not on the list.
                sessionStorage.doNotShare = false;
            }
        });
}
